deploy:
  name: ðŸš€ Deploy to k3s via SSH
  needs: build-and-push
  runs-on: ubuntu-latest

  steps:
    - name: SSH & Deploy
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_DEPLOY_KEY }}
        known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
        script: |
          set -e
          echo "::group::Deploying to k3s"
          # point kubectl at the masterâ€™s k3s config
          export KUBECONFIG=/etc/rancher/k3s/k3s.yaml

          # update to the :latest image
          kubectl -n ocdlifts set image deployment/ocdlifts \
            ocdlifts=lucidreline/ocdlifts:latest

          # wait for rollout
          kubectl -n ocdlifts rollout status deployment/ocdlifts --timeout=2m
          echo "::endgroup::"
